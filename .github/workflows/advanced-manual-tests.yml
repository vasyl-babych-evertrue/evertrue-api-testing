name: Advanced Manual Test Runner

on:
  workflow_dispatch:
    inputs:
      test_path:
        description: 'Ð¨Ð»ÑÑ… Ð´Ð¾ Ñ‚ÐµÑÑ‚Ñ–Ð² (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´: tests/auth Ð°Ð±Ð¾ tests/auth/auth-session.spec.ts)'
        required: true
        type: string
        default: 'tests/auth'
      
      environment:
        description: 'ÐžÑ‚Ð¾Ñ‡ÐµÐ½Ð½Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ'
        required: true
        type: choice
        default: 'stage'
        options:
          - 'stage'
          - 'production'
      
      browser:
        description: 'Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ñ–Ð²'
        required: false
        type: choice
        default: 'chromium'
        options:
          - 'chromium'
          - 'firefox'
          - 'webkit'
          - 'all'
      
      headed:
        description: 'Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð² headed Ñ€ÐµÐ¶Ð¸Ð¼Ñ– (Ð· UI)'
        required: false
        type: boolean
        default: false
      
      debug:
        description: 'Debug Ñ€ÐµÐ¶Ð¸Ð¼ (Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ– Ð»Ð¾Ð³Ð¸)'
        required: false
        type: boolean
        default: false
      
      retries:
        description: 'ÐšÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ñ… ÑÐ¿Ñ€Ð¾Ð± Ð¿Ñ€Ð¸ Ð¿Ð°Ð´Ñ–Ð½Ð½Ñ– Ñ‚ÐµÑÑ‚Ñƒ'
        required: false
        type: number
        default: 0
      
      grep:
        description: 'Ð¤Ñ–Ð»ÑŒÑ‚Ñ€ Ñ‚ÐµÑÑ‚Ñ–Ð² (regex pattern, Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´: "should create")'
        required: false
        type: string
        default: ''

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: |
          if [ "${{ inputs.browser }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install --with-deps ${{ inputs.browser }}
          fi

      - name: ðŸ§ª Run tests
        run: |
          CMD="npx playwright test ${{ inputs.test_path }}"
          
          # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ browser
          if [ "${{ inputs.browser }}" != "all" ]; then
            CMD="$CMD --project=${{ inputs.browser }}"
          fi
          
          # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ headed Ñ€ÐµÐ¶Ð¸Ð¼
          if [ "${{ inputs.headed }}" = "true" ]; then
            CMD="$CMD --headed"
          fi
          
          # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ debug
          if [ "${{ inputs.debug }}" = "true" ]; then
            CMD="$CMD --debug"
          fi
          
          # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ retries
          if [ "${{ inputs.retries }}" != "0" ]; then
            CMD="$CMD --retries=${{ inputs.retries }}"
          fi
          
          # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ grep Ñ„Ñ–Ð»ÑŒÑ‚Ñ€
          if [ -n "${{ inputs.grep }}" ]; then
            CMD="$CMD --grep='${{ inputs.grep }}'"
          fi
          
          # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ reporter
          CMD="$CMD --reporter=html,list"
          
          echo "Executing: $CMD"
          eval $CMD
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD }}
          REGULAR_USER_EMAIL: ${{ secrets.REGULAR_USER_EMAIL }}
          REGULAR_USER_PASSWORD: ${{ secrets.REGULAR_USER_PASSWORD }}

      - name: ðŸ“Š Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ inputs.environment }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: ðŸ“„ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ inputs.environment }}-${{ github.run_number }}
          path: test-results/
          retention-days: 30

      - name: ðŸ“Š Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Path | \`${{ inputs.test_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | \`${{ inputs.browser }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Headed Mode | \`${{ inputs.headed }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Mode | \`${{ inputs.debug }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Retries | \`${{ inputs.retries }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Grep Filter | \`${{ inputs.grep }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Report: \`playwright-report-${{ inputs.environment }}-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test Results: \`test-results-${{ inputs.environment }}-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Comment on commit (if triggered from PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = `## ðŸ§ª Manual Test Run Results\n\n`;
            comment += `**Test Path:** \`${{ inputs.test_path }}\`\n`;
            comment += `**Environment:** \`${{ inputs.environment }}\`\n`;
            comment += `**Browser:** \`${{ inputs.browser }}\`\n`;
            comment += `**Status:** ${{ job.status }}\n\n`;
            comment += `[View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
